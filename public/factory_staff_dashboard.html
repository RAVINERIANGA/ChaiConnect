<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Factory Staff Dashboard | ChaiConnect</title>
    <link rel="stylesheet" href="/css/factory_style.css" />
</head>

<body>
    <div class="sidebar">
        <h2>ChaiConnect</h2>
        <ul>
            <li><a href="#overview" class="active">Dashboard</a></li>
            <li><a href="#record-delivery">Record Delivery</a></li>
            <li><a href="#view-deliveries">View All Deliveries</a></li>
            <li><a href="#logout" onclick="logout()">Logout</a></li>
        </ul>
    </div>

    <div class="main-content">
        <section id="overview">
            <h1>Welcome, Factory Staff</h1>
            <p>Monitor and record deliveries from farmers to your tea processing facility.</p>
        </section>

        <section id="record-delivery">
            <h2>Record Farmer Delivery</h2>
            <form id="deliveryForm">
                <label for="farmer_id">Farmer ID:</label>
                <input type="text" id="farmer_id" name="farmer_id" required>

                <label for="quantity">Quantity (kg):</label>
                <input type="number" id="quantity" name="quantity" required>

                <label for="quality">Quality Grade:</label>
                <select id="quality" name="quality">
                    <option value="A">Grade A</option>
                    <option value="B">Grade B</option>
                    <option value="C">Grade C</option>
                </select>

                <button type="submit">Submit Delivery</button>
            </form>
            <div id="deliveryMessage"></div>
        </section>

        <section id="view-deliveries">
            <h2>All Recorded Deliveries</h2>
            <table id="deliveriesTable">
                <thead>
                    <tr>
                        <th>Delivery ID</th>
                        <th>Farmer ID</th>
                        <th>Quantity (kg)</th>
                        <th>Quality</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('deliveryForm');
            const tableBody = document.querySelector('#deliveriesTable tbody');
            const message = document.getElementById('deliveryMessage');

            // Submit delivery
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const data = {
                    farmer_id: form.farmer_id.value,
                    quantity: form.quantity.value,
                    quality: form.quality.value
                };

                const res = await fetch('/deliveries', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                if (result.success) {
                    message.textContent = 'Delivery recorded successfully!';
                    form.reset();
                    loadDeliveries();
                } else {
                    message.textContent = 'Error recording delivery.';
                }
            });

            // Load existing deliveries
            async function loadDeliveries() {
                const res = await fetch('/deliveries');
                const deliveries = await res.json();

                tableBody.innerHTML = '';
                deliveries.forEach(d => {
                    const row = `<tr>
        <td>${d.delivery_id}</td>
        <td>${d.farmer_id}</td>
        <td>${d.quantity}</td>
        <td>${d.quality}</td>
        <td>${new Date(d.created_at).toLocaleString()}</td>
      </tr>`;
                    tableBody.innerHTML += row;
                });
            }

            loadDeliveries();
        });

        function logout() {
            fetch('/logout', { method: 'POST' })
                .then(() => (window.location.href = '/'));
        }

    </script>
</body>

</html>