<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Delivery History | ChaiConnect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 25px;
    }
    .status-badge {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .status-pending {
      background-color: #fff3e0;
      color: #e65100;
    }
    .status-scheduled {
      background-color: #e3f2fd;
      color: #1565c0;
    }
    .status-completed {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    .status-cancelled {
      background-color: #ffebee;
      color: #c62828;
    }
    .table-responsive {
      overflow-x: auto;
    }
    .table th {
      background-color: #2e7d32;
      color: white;
    }
    .actions-dropdown .dropdown-menu {
      min-width: 150px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0"><i class="fas fa-history me-2"></i> My Delivery History</h2>
      <a href="/request_delivery.html" class="btn btn-success">
        <i class="fas fa-plus me-2"></i> New Request
      </a>
    </div>

    <div class="row mb-4 g-3">
      <div class="col-md-3">
        <select class="form-select" id="statusFilter">
          <option value="">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="scheduled">Scheduled</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
      <div class="col-md-3">
        <select class="form-select" id="monthFilter">
          <option value="">All Months</option>
          <option value="01">January</option>
          <option value="02">February</option>
          <option value="03">March</option>
          <option value="04">April</option>
          <option value="05">May</option>
          <option value="06">June</option>
          <option value="07">July</option>
          <option value="08">August</option>
          <option value="09">September</option>
          <option value="10">October</option>
          <option value="11">November</option>
          <option value="12">December</option>
        </select>
      </div>
      <div class="col-md-3">
        <select class="form-select" id="yearFilter"></select>
      </div>
      <div class="col-md-3">
        <button class="btn btn-outline-secondary w-100" onclick="applyFilters()">
          <i class="fas fa-filter me-2"></i> Filter
        </button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Request Date</th>
            <th>Pickup Date</th>
            <th>Status</th>
            <th>Estimated Qty (kg)</th>
            <th>Actual Qty (kg)</th>
            <th>Collection Center</th>
            <th>Quality Grade</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="deliveryTableBody">
          <tr>
            <td colspan="8" class="text-center py-4">
              <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="text-muted" id="resultCount">Showing 0 results</div>
      <button class="btn btn-outline-success" onclick="downloadCSV()">
        <i class="fas fa-file-csv me-2"></i> Export to CSV
      </button>
    </div>
  </div>

  <!-- Cancel Request Modal -->
  <div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Cancel Delivery Request</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to cancel this delivery request?</p>
          <textarea id="cancelReason" class="form-control mt-3" placeholder="Reason for cancellation (optional)"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" onclick="confirmCancel()">Confirm Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let allDeliveries = [];
    let cancelModal = null;
    let currentRequestId = null;

    document.addEventListener("DOMContentLoaded", async () => {
      cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));
      populateYears();
      await loadDeliveries();
    });

    async function loadDeliveries() {
      try {
        const response = await fetch('/api/delivery-requests', {
          credentials: 'include'
        });
        
        if (!response.ok) throw new Error('Failed to load deliveries');
        
        allDeliveries = await response.json();
        applyFilters();
      } catch (error) {
        console.error('Error loading deliveries:', error);
        document.getElementById('deliveryTableBody').innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-4 text-danger">
              <i class="fas fa-exclamation-circle me-2"></i>
              ${error.message || 'Failed to load delivery history. Please try again later.'}
            </td>
          </tr>
        `;
      }
    }

    function renderTable(data) {
      const tbody = document.getElementById('deliveryTableBody');
      
      if (data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-4 text-muted">
              <i class="fas fa-inbox me-2"></i>
              No delivery requests found
            </td>
          </tr>
        `;
        document.getElementById('resultCount').textContent = 'Showing 0 results';
        return;
      }

      tbody.innerHTML = data.map(delivery => `
        <tr>
          <td>${new Date(delivery.created_at).toLocaleDateString()}</td>
          <td>${delivery.pickup_date ? new Date(delivery.pickup_date).toLocaleDateString() : 'N/A'}</td>
          <td>
            <span class="status-badge status-${delivery.status}">
              ${delivery.status.charAt(0).toUpperCase() + delivery.status.slice(1)}
            </span>
          </td>
          <td>${delivery.estimated_quantity || 'N/A'}</td>
          <td>${delivery.actual_quantity || 'N/A'}</td>
          <td>${delivery.collection_center || 'N/A'}</td>
          <td>${delivery.quality_grade || 'N/A'}</td>
          <td>
            <div class="dropdown actions-dropdown">
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                      data-bs-toggle="dropdown" aria-expanded="false">
                Actions
              </button>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="#" onclick="viewDetails('${delivery.id}')">
                    <i class="fas fa-eye me-2"></i> View Details
                  </a>
                </li>
                ${delivery.status === 'pending' || delivery.status === 'scheduled' ? `
                <li>
                  <a class="dropdown-item text-danger" href="#" 
                     onclick="showCancelModal('${delivery.id}')">
                    <i class="fas fa-times-circle me-2"></i> Cancel Request
                  </a>
                </li>
                ` : ''}
              </ul>
            </div>
          </td>
        </tr>
      `).join('');

      document.getElementById('resultCount').textContent = `Showing ${data.length} of ${allDeliveries.length} results`;
    }

    function applyFilters() {
      const status = document.getElementById('statusFilter').value;
      const month = document.getElementById('monthFilter').value;
      const year = document.getElementById('yearFilter').value;

      const filtered = allDeliveries.filter(d => {
        const dDate = new Date(d.pickup_date || d.created_at);
        const dYear = dDate.getFullYear().toString();
        const dMonth = (dDate.getMonth() + 1).toString().padStart(2, '0');
        
        return (!status || d.status === status) &&
               (!month || dMonth === month) &&
               (!year || dYear === year);
      });

      // Sort by date (newest first)
      filtered.sort((a, b) => new Date(b.pickup_date || b.created_at) - new Date(a.pickup_date || a.created_at));
      
      renderTable(filtered);
    }

    function populateYears() {
      const yearFilter = document.getElementById("yearFilter");
      const currentYear = new Date().getFullYear();
      
      yearFilter.innerHTML = '<option value="">All Years</option>';
      
      for (let y = currentYear; y >= 2020; y--) {
        const option = document.createElement("option");
        option.value = y;
        option.textContent = y;
        yearFilter.appendChild(option);
      }
    }

    function showCancelModal(requestId) {
      currentRequestId = requestId;
      document.getElementById('cancelReason').value = '';
      cancelModal.show();
    }

    async function confirmCancel() {
      const reason = document.getElementById('cancelReason').value;
      
      try {
        const response = await fetch(`/api/delivery-requests/${currentRequestId}/cancel`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ reason }),
          credentials: 'include'
        });

 const result = await response.json();

        if (!response.ok) throw new Error('Failed to cancel request');

        cancelModal.hide();
        await loadDeliveries(); // Refresh the list
        
        // Show success message (you could add a toast here)
        alert('Delivery request cancelled successfully');
      } catch (error) {
        console.error('Error cancelling request:', error);
         alert(error.message || 'Failed to cancel delivery request');
      }
    }

    function viewDetails(requestId) {
      // In a real app, you might show a modal with full details
      const delivery = allDeliveries.find(d => d.id === requestId);
      if (delivery) {
        alert(`Delivery Details:\n\n` +
              `Status: ${delivery.status}\n` +
              `Request Date: ${new Date(delivery.created_at).toLocaleString()}\n` +
              `Pickup Date: ${delivery.pickup_date ? new Date(delivery.pickup_date).toLocaleDateString() : 'Not scheduled'}\n` +
              `Collection Center: ${delivery.collection_center || 'Not specified'}\n` +
              `Notes: ${delivery.notes || 'None'}`);
      }
    }

    function downloadCSV() {
      const filteredRows = document.querySelectorAll("#deliveryTableBody tr");
      if (filteredRows.length === 0) {
        alert('No data to export');
        return;
      }

      let csv = "Request Date,Pickup Date,Status,Estimated Qty,Actual Qty,Collection Center,Quality Grade\n";
      
      filteredRows.forEach(row => {
        const cols = row.querySelectorAll("td");
        if (cols.length >= 7) { // Ensure we have enough columns
          const rowData = [
            cols[0].textContent.trim(),
            cols[1].textContent.trim(),
            cols[2].textContent.trim(),
            cols[3].textContent.trim(),
            cols[4].textContent.trim(),
            cols[5].textContent.trim(),
            cols[6].textContent.trim()
          ].map(field => field.includes(',') ? `"${field}"` : field);
          
          csv += rowData.join(',') + '\n';
        }
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `delivery_history_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
