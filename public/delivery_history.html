<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Delivery History | ChaiConnect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      color: #2c3e50;
    }

    .actions {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      margin: 20px 0;
    }

    .actions select, .actions button {
      padding: 10px;
      margin: 5px;
      font-size: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      border: 1px solid #ccc;
    }

    th {
      background-color: #2ecc71;
      color: #fff;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .footer {
      text-align: center;
      margin-top: 15px;
      font-size: 0.9rem;
      color: #7f8c8d;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ðŸ“‹ My Delivery History</h2>

    <div class="actions">
      <div>
        <select id="monthFilter">
          <option value="">All Months</option>
          <option value="01">January</option>
          <option value="02">February</option>
          <option value="03">March</option>
          <option value="04">April</option>
          <option value="05">May</option>
          <option value="06">June</option>
          <option value="07">July</option>
          <option value="08">August</option>
          <option value="09">September</option>
          <option value="10">October</option>
          <option value="11">November</option>
          <option value="12">December</option>
        </select>
        <select id="yearFilter"></select>
        <button onclick="applyFilters()">Filter</button>
      </div>
      <button onclick="downloadCSV()">â¬‡ Download CSV</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Quantity (KG)</th>
          <th>Quality Grade</th>
          <th>Collection Center</th>
        </tr>
      </thead>
      <tbody id="deliveryTableBody">
        <tr><td colspan="4">Loading...</td></tr>
      </tbody>
    </table>

    <div class="footer">Filtered deliveries based on your selected date. You can export to CSV above.</div>
  </div>

  <script>
    let allDeliveries = [];

    document.addEventListener("DOMContentLoaded", async () => {
      populateYears();
      const meRes = await fetch('/api/me');
      const meData = await meRes.json();
      const farmerId = meData.userId;

      const res = await fetch(`/api/farmer/${farmerId}/deliveries`);
      const data = await res.json();
      allDeliveries = data;
      renderTable(data);
    });

    function renderTable(data) {
      const tbody = document.getElementById('deliveryTableBody');
      tbody.innerHTML = '';

      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">No deliveries found.</td></tr>';
        return;
      }

      data.forEach(delivery => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${delivery.date}</td>
          <td>${delivery.quantity_kg} kg</td>
          <td>${delivery.quality_grade}</td>
          <td>${delivery.collection_center || 'N/A'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function applyFilters() {
      const month = document.getElementById('monthFilter').value;
      const year = document.getElementById('yearFilter').value;

      const filtered = allDeliveries.filter(d => {
        const dYear = d.date.substring(0, 4);
        const dMonth = d.date.substring(5, 7);
        return (!month || dMonth === month) && (!year || dYear === year);
      });

      renderTable(filtered);
    }

    function downloadCSV() {
      let csv = "Date,Quantity (KG),Quality Grade,Collection Center\n";
      const rows = document.querySelectorAll("#deliveryTableBody tr");
      rows.forEach(row => {
        const cols = row.querySelectorAll("td");
        if (cols.length) {
          const rowData = Array.from(cols).map(col => "${col.textContent.trim()}").join(",");
          csv += rowData + "\n";
        }
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "delivery_history.csv";
      link.click();
    }

    function populateYears() {
      const yearFilter = document.getElementById("yearFilter");
      const currentYear = new Date().getFullYear();
      for (let y = currentYear; y >= 2022; y--) {
        const option = document.createElement("option");
        option.value = y;
        option.textContent = y;
        yearFilter.appendChild(option);
      }
    }
  </script>
</body>
</html>
